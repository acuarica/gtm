<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <title>gtm Dashboard</title>
</head>
<body>
  <nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="#"><img src="https://cloud.githubusercontent.com/assets/630550/19619834/43c460dc-9835-11e6-8652-1c8fff91cf02.png" width="82" height="34" class="d-inline-block align-top" alt="">Dashboard</a>
  </nav>
  <main role="main" class="container">
    <div style="width:40%;height:400px;">
      <canvas id="projectTotalsChart"></canvas>
    </div>
    <!-- <div style="width:60%;height:500px;"> -->
    <!-- <div> -->
    <div style="height:200px;">
      <canvas id="activityChart"></canvas>
    </div>
    <!-- <div style="width:40%;height:200px;">
    <canvas id="projectStatusChart" width="200" height="200"></canvas>
  </div> -->
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.4"></script>
  <script src="https://unpkg.com/chartjs-chart-timeline@0.3.0/timeline.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix/dist/chartjs-chart-matrix.js"></script>
  <script>

    Chart.plugins.unregister(ChartDataLabels);

    const colors = {
      blue: 'rgb(54, 162, 235)',
    };

    function pad0(num) {
      return ("0" + num).slice(-2);
    }

    function hhmm(secs) {
      var minutes = Math.floor(secs / 60);
      const hours = Math.floor(minutes / 60)
      minutes = minutes % 60;
      return `${pad0(hours)}h ${pad0(minutes)}m`;
    }

    function fetchjson(url, f) {
      fetch(`${url}${window.location.search}`).then(data => data.json()).then(f)
    }

    function newchart(chartid, config) {
      const ctx = document.getElementById(chartid).getContext('2d');
      new Chart(ctx, config);
    }

    fetchjson('/data/commits', res => {
      const projects = {};
      for (const commit of res) {
        let project = projects[commit.Project];
        if (project === undefined) {
          project = { name: commit.Project, total: 0, commitcount: 0, timeline: {} };
          projects[commit.Project] = project;
        }
        project.commitcount++;
        if (commit.Note.Files === null) {
          console.warn("gtm check: Commit note files not available:", commit);
          continue;
        }
        for (const file of commit.Note.Files) {
          let filesecs = 0;
          for (const timestamp in file.Timeline) {
            const secs = file.Timeline[timestamp];
            if (secs > 3600) console.warn("gtm check: Duration (in seconds) should be less than 3600:", secs);
            if (timestamp % 3600 !== 0) console.warn("gtm check: Timestamp (unix time) should be by the hour:", timestamp);
            project.total += secs;
            const date = moment.unix(timestamp).startOf('day').format('YYYY-MM-DD');
            const hour = moment.unix(timestamp).hour();
            let dateline = project.timeline[date];
            if (dateline === undefined) {
              dateline = {};
              project.timeline[date] = dateline;
            }
            let hourline = dateline[hour];
            if (hourline === undefined) {
              hourline = { total: 0 };
              dateline[hour] = hourline;
            }
            hourline.total += secs;
            filesecs += secs;
          }
          if (filesecs !== file.TimeSpent) console.warn("gtm check: Timeline seconds does not add up to duration in file.");
        }
      }
      const daily = {};
      Object.values(projects).map(p => {
        const data = [];
        for (const date in p.timeline) {
          for (const hour in p.timeline[date]) {
            const secs = p.timeline[date][hour];
            data.push({
              x: `${pad0(hour)}:00`, y: date, v: secs.total,
            });
            let day = daily[date];
            if (day === undefined) {
              day = { total: 0 };
              daily[date] = day;
            }
            day.total += secs.total;
          }
        }
        p.timelineMatrix = data;
      });

      newchart('projectTotalsChart', {
        type: 'doughnut',
        plugins: [ChartDataLabels],
        data: {
          datasets: [{
            data: Object.values(projects).map(x => x.total),
            commitcounts: Object.values(projects).map(x => x.commitcount),
          }],
          labels: Object.keys(projects),
        },
        options: {
          maintainAspectRatio: false,
          title: { display: true, text: 'Reported time by Project' },
          legend: { position: 'left', },
          plugins: {
            colorschemes: { scheme: 'office.BlackTie6' },
            datalabels: {
              display: 'auto',
              formatter: (value, context) => hhmm(value),
            },
          },
          tooltips: {
            callbacks: {
              label: (tooltipItem, data) => {
                const i = tooltipItem.index;
                const ds = data.datasets[0];
                const commitcount = ds.commitcounts[i];
                const committext = commitcount == 1 ? 'commit' : 'commits';
                return `${data.labels[i]}: ${hhmm(ds.data[i])} (${commitcount} ${committext})`;
              },
            }
          },
        }
      });

      const max = moment();
      const min = max.clone().subtract(7, 'day');
      // console.log(min, max);
      // console.log(min.format('X'), max.format('X'));

      newchart('activityChart', {
        type: 'matrix',
        data: {
          datasets: Object.values(projects).map(p => {
            return {
              label: p.name,
              data: p.timelineMatrix,
              backgroundColor2: function (ctx) {
                const value = ctx.dataset.data[ctx.dataIndex].v;
                const levels = 3;
                const alpha = Math.floor(value * levels / 3600) / levels + (1 / levels);
                console.log(ctx, value, alpha);
                BlackTie6 = ['#6f6f74', '#a7b789', '#beae98', '#92a9b9', '#9c8265', '#8d6974'];
                var c = BlackTie6[ctx.datasetIndex % BlackTie6.length];
                return Color(c).alpha(alpha).rgbString();
              },
              borderWidth: 1,
              width: function (ctx) {
                const value = ctx.dataset.data[ctx.dataIndex].v;
                const levels = 10;
                const alpha = Math.floor(value * levels / 3600) / levels + (1 / levels);
                var a = ctx.chart.chartArea;
                return (a.right - a.left) / 25;
              },
              height: function (ctx) {
                const value = ctx.dataset.data[ctx.dataIndex].v;
                const levels = 4;
                const alpha = Math.floor(value * levels / 3600) / levels + (1 / levels);
                var a = ctx.chart.chartArea;
                return alpha * (a.bottom - a.top) / 10;
              },
            }
          }),
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            xAxes: [{
              type: 'time',
              offset: true,
              time: { unit: 'hour', parser: 'HH:mm' },
              gridLines: { drawOnChartArea: false, },
            }],
            yAxes: [{
              type: 'time',
              offset: true,
              time: { unit: 'day', parser: 'YYYY-MM-DD' },
              ticks: {
                // reverse: true,
                // min: min.format('X'),
                // max: max.format('X'),
              },
              gridLines: { drawOnChartArea: false, },
            }, {
              type: 'time',
              offset: true,
              position: 'right',
              time: { unit: 'day', parser: 'YYYY-MM-DD' },
              ticks: {
                // reverse: true,
                callback: function (value, index, values) {
                  const d = moment(values[index].value).format('YYYY-MM-DD');
                  const date = daily[d];
                  return date === undefined ? value : hhmm(date.total);
                }
              },
              gridLines: { drawOnChartArea: false, },
            }],
          },
          plugins: {
            colorschemes: { scheme: 'office.BlackTie6' },
            zoom: {
              pan: {
                enabled: true,
                mode: "y",
                speed: 100,
                threshold: 10,
              },
              zoom: {
                enabled: true,
                mode: 'y',
                speed: 0.1,
                sensitivity: 3,
              }
            },
          }
        }
      });
    });

    // $('#today').on('click', function (e) {
    //   pie("/data/projects/totals?today=1", 'myChart', 'Reported time by Project')
    // })
    // $('#yesterday').on('click', function (e) {
    //   pie("/data/projects/totals?yesterday=1", 'myChart', 'Reported time by Project')
    // })
    // $('#thisweek').on('click', function (e) {
    //   pie("/data/projects/totals?thisweek=1", 'myChart', 'Reported time by Project')
    // })
    // $('#lastweek').on('click', function (e) {
    //   pie("/data/projects/totals?lastweek=1", 'myChart', 'Reported time by Project')
    // })
    // $('#thismonth').on('click', function (e) {
    //   pie("/data/projects/totals?thismonth=1", 'myChart', 'Reported time by Project')
    // })
    // $('#lastmonth').on('click', function (e) {
    //   pie("/data/projects/totals?lastmonth=1", 'myChart', 'Reported time by Project')
    // })
    // $('#thisyear').on('click', function (e) {
    //   pie("/data/projects/totals?thisyear=1", 'myChart', 'Reported time by Project')
    // })
    // $('#lastyear').on('click', function (e) {
    //   pie("/data/projects/totals?lastyear=1", 'myChart', 'Reported time by Project')
    // })

    // pie("/data/status/totals", "projectStatusChart", 'Status time by Project')
  </script>
</body>
</html>